<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Nh·∫≠p ch·ªâ s·ªë n∆∞·ªõc</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <style>
    .form-box {
      max-width: 550px;
      margin: 40px auto;
      padding: 30px;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      background-color: #f8f9fa;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }
    .form-header {
      font-size: 1.6rem;
      font-weight: bold;
      color: #007bff;
      text-align: center;
      margin-bottom: 25px;
    }
    .form-label {
      font-weight: 500;
    }
    .form-group select:disabled {
      background-color: #e9ecef;
    }

    /* Custom styles cho month picker */
    .month-picker {
      position: relative;
    }

    .month-input {
      cursor: pointer;
      background-color: white;
    }

    .month-input:focus {
      box-shadow: 0 0 5px rgba(0, 123, 255, 0.5);
    }

    /* ·∫®n c√°c th√°ng ƒë√£ s·ª≠ d·ª•ng */
    .disabled-month {
      background-color: #f8f9fa !important;
      color: #6c757d !important;
      cursor: not-allowed !important;
      text-decoration: line-through;
    }
  </style>
</head>
<body>

<div class="container">
  <div class="form-box">

    <!-- üî¥ TH√îNG B√ÅO L·ªñI -->
    <div th:if="${errorMessage}" class="alert alert-danger text-center">
      <span th:text="${errorMessage}"></span>
    </div>

    <div class="form-header">Nh·∫≠p ch·ªâ s·ªë n∆∞·ªõc</div>
    <form th:action="@{/water-usage/create}" method="post">

      <!-- ‚úÖ Contract ID -->
      <input type="hidden" name="contractId" th:value="${contract.id}" />

      <div class="form-group">
        <label class="form-label">ƒê·ªãa ch·ªâ</label>
        <input type="text" class="form-control" th:value="${contract.apartment.address}" readonly>
      </div>

      <div class="form-group">
        <label class="form-label">Ch·ªß s·ªü h·ªØu</label>
        <input type="text" class="form-control" th:value="${contract.customer.fullName}" readonly>
      </div>

      <div class="form-group">
        <label class="form-label">D·ªãch v·ª•</label>
        <input type="text" class="form-control" th:value="${contract.serviceType.name}" readonly>
      </div>

      <!-- ‚úÖ Month Picker v·ªõi Calendar -->
      <div class="form-group">
        <label class="form-label">Th√°ng c·∫ßn nh·∫≠p</label>
        <div class="month-picker">
          <input type="month"
                 id="monthPicker"
                 name="month"
                 class="form-control month-input"
                 required>
        </div>
        <small class="form-text text-muted">Ch·ªçn th√°ng t·ª´ l·ªãch. C√°c th√°ng ƒë√£ t·∫°o h√≥a ƒë∆°n s·∫Ω kh√¥ng th·ªÉ ch·ªçn.</small>
      </div>

      <div class="form-group">
        <label class="form-label">Ch·ªâ s·ªë c≈©</label>
        <input type="number" class="form-control" th:value="${previousIndex}" readonly>
      </div>

      <div class="form-group">
        <label class="form-label">Ch·ªâ s·ªë m·ªõi</label>
        <input type="number" class="form-control" name="currentIndex" required>
      </div>

      <button type="submit" class="btn btn-primary btn-block">T·∫°o h√≥a ƒë∆°n</button>
    </form>
  </div>
</div>

<!-- JavaScript ƒë·ªÉ x·ª≠ l√Ω logic disable c√°c th√°ng ƒë√£ s·ª≠ d·ª•ng -->
<script th:inline="javascript">
  document.addEventListener('DOMContentLoaded', function() {
      const monthPicker = document.getElementById('monthPicker');

      // L·∫•y danh s√°ch c√°c th√°ng ƒë√£ s·ª≠ d·ª•ng t·ª´ Thymeleaf
      const usedMonths = /*[[${usedMonths}]]*/ [];

      console.log('Used months:', usedMonths);

      // Thi·∫øt l·∫≠p gi·ªõi h·∫°n th·ªùi gian
      const now = new Date();
      const maxDate = new Date(now.getFullYear() + 2, 11, 31); // Cho ph√©p ƒë·∫øn 2 nƒÉm t·ªõi
      const minDate = new Date(now.getFullYear() - 2, 0, 1); // Cho ph√©p t·ª´ 2 nƒÉm tr∆∞·ªõc

      // Set min v√† max cho input (m·ªü r·ªông ph·∫°m vi)
      monthPicker.min = minDate.toISOString().slice(0, 7);
      monthPicker.max = maxDate.toISOString().slice(0, 7);

      // T·∫°o style ƒë·ªÉ l√†m m·ªù c√°c th√°ng ƒë√£ s·ª≠ d·ª•ng
      const style = document.createElement('style');
      style.textContent = `
          /* Style cho month picker khi c√≥ th√°ng b·ªã disable */
          input[type="month"]::-webkit-calendar-picker-indicator {
              filter: none;
          }

          /* Custom tooltip */
          .month-picker-wrapper {
              position: relative;
          }

          .month-tooltip {
              position: absolute;
              bottom: -25px;
              left: 0;
              background: #f8f9fa;
              border: 1px solid #dee2e6;
              padding: 5px 8px;
              border-radius: 4px;
              font-size: 0.8rem;
              color: #6c757d;
              display: none;
              z-index: 1000;
          }

          .month-tooltip.show {
              display: block;
          }
      `;
      document.head.appendChild(style);

<!--      // Th√™m tooltip ƒë·ªÉ hi·ªÉn th·ªã c√°c th√°ng ƒë√£ s·ª≠ d·ª•ng-->
<!--      const tooltip = document.createElement('div');-->
<!--      tooltip.className = 'month-tooltip';-->
<!--      if (usedMonths.length > 0) {-->
<!--          tooltip.textContent = 'C√°c th√°ng ƒë√£ c√≥ h√≥a ƒë∆°n: ' + usedMonths.join(', ');-->
<!--      } else {-->
<!--          tooltip.textContent = 'Ch∆∞a c√≥ th√°ng n√†o c√≥ h√≥a ƒë∆°n';-->
<!--      }-->
<!--      monthPicker.parentElement.appendChild(tooltip);-->

<!--      // Hi·ªÉn th·ªã tooltip khi focus-->
<!--      monthPicker.addEventListener('focus', function() {-->
<!--          tooltip.classList.add('show');-->
<!--      });-->

<!--      monthPicker.addEventListener('blur', function() {-->
<!--          tooltip.classList.remove('show');-->
<!--      });-->

      // X·ª≠ l√Ω khi ng∆∞·ªùi d√πng ch·ªçn th√°ng
      monthPicker.addEventListener('input', function() {
          const selectedMonth = this.value;

          // Ki·ªÉm tra n·∫øu ch·ªçn th√°ng ƒë√£ s·ª≠ d·ª•ng
          if (usedMonths.includes(selectedMonth)) {
              // L√†m m·ªù input v√† hi·ªÉn th·ªã c·∫£nh b√°o
              this.style.backgroundColor = '#f8f9fa';
              this.style.color = '#6c757d';
              this.style.borderColor = '#dc3545';

              // Hi·ªÉn th·ªã th√¥ng b√°o
              alert('‚ö†Ô∏è Th√°ng ' + selectedMonth + ' ƒë√£ t·∫°o h√≥a ƒë∆°n r·ªìi!\nVui l√≤ng ch·ªçn th√°ng kh√°c.');

              // Reset v·ªÅ tr·∫°ng th√°i b√¨nh th∆∞·ªùng v√† x√≥a gi√° tr·ªã
              setTimeout(() => {
                  this.value = '';
                  this.style.backgroundColor = '';
                  this.style.color = '';
                  this.style.borderColor = '';
              }, 100);

              return false;
          } else {
              // Reset style v·ªÅ b√¨nh th∆∞·ªùng n·∫øu ch·ªçn th√°ng h·ª£p l·ªá
              this.style.backgroundColor = '';
              this.style.color = '';
              this.style.borderColor = '';
          }
      });

      // NgƒÉn ch·∫∑n submit n·∫øu ch·ªçn th√°ng ƒë√£ s·ª≠ d·ª•ng
      document.querySelector('form').addEventListener('submit', function(e) {
          const selectedMonth = monthPicker.value;

          if (!selectedMonth) {
              alert('Vui l√≤ng ch·ªçn th√°ng!');
              e.preventDefault();
              return false;
          }

          if (usedMonths.includes(selectedMonth)) {
              alert('‚ùå Kh√¥ng th·ªÉ t·∫°o h√≥a ƒë∆°n cho th√°ng ƒë√£ s·ª≠ d·ª•ng!');
              e.preventDefault();
              return false;
          }
      });

      // Th√™m hi·ªáu ·ª©ng visual khi hover
      monthPicker.addEventListener('mouseenter', function() {
          if (usedMonths.length > 0) {
              tooltip.classList.add('show');
          }
      });

      monthPicker.addEventListener('mouseleave', function() {
          if (!this.matches(':focus')) {
              tooltip.classList.remove('show');
          }
      });
  });
</script>


</body>
</html>